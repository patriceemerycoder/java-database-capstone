<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Clinic - Healthcare Management System</title>
    <link rel="icon" href="assets/images/logo/logo.png" type="image/png">
    
    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/index.css">
    
    <!-- JavaScript Files -->
    <script src="js/util.js" defer></script>
    <script src="js/components/header.js" defer></script>
    <script src="js/components/footer.js" defer></script>
    <script src="js/components/modals.js" defer></script>
</head>
<body>
    <!-- Alert Container -->
    <div id="alertContainer"></div>
    
    <!-- Header Section -->
    <div id="header"></div>
    
    <!-- Main Content -->
    <main class="main-container">
        <div class="role-selection-container">
            <div class="welcome-header">
                <h1>Welcome to Smart Clinic</h1>
                <p>Your comprehensive healthcare management system. Please select your role to continue.</p>
            </div>
            
            <div class="role-cards">
                <div class="role-card admin" onclick="selectRole('admin')" tabindex="0">
                    <div class="role-icon">
                        üë®‚Äçüíº
                    </div>
                    <h3>Administrator</h3>
                    <p>Manage doctors, patients, and system settings</p>
                </div>
                
                <div class="role-card doctor" onclick="selectRole('doctor')" tabindex="0">
                    <div class="role-icon">
                        üë®‚Äç‚öïÔ∏è
                    </div>
                    <h3>Doctor</h3>
                    <p>View appointments, manage patients, and prescribe medications</p>
                </div>
                
                <div class="role-card patient" onclick="selectRole('patient')" tabindex="0">
                    <div class="role-icon">
                        üè•
                    </div>
                    <h3>Patient</h3>
                    <p>Book appointments, view medical history, and manage your health</p>
                </div>
            </div>
            
            <div class="footer-note">
                <p>Need help? <a href="#" onclick="showHelpModal()">Contact Support</a></p>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingContainer" class="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </main>
    
    <!-- Footer Section -->
    <div id="footer"></div>
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Login</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-control" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                            Login
                        </button>
                    </div>
                </form>
                
                <div class="text-center mt-3">
                    <p>Don't have an account? <a href="#" onclick="showSignupModal()">Sign up here</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="signupModalTitle">Sign Up</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupName" class="form-label">Full Name</label>
                        <input type="text" id="signupName" class="form-control" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail" class="form-label">Email Address</label>
                        <input type="email" id="signupEmail" class="form-control" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" id="signupPassword" class="form-control" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPhone" class="form-label">Phone Number</label>
                        <input type="tel" id="signupPhone" class="form-control" placeholder="XXX-XXX-XXXX" required>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group" id="addressGroup" style="display: none;">
                        <label for="signupAddress" class="form-label">Address</label>
                        <textarea id="signupAddress" class="form-control" rows="3"></textarea>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group" id="specialtyGroup" style="display: none;">
                        <label for="signupSpecialty" class="form-label">Specialty</label>
                        <select id="signupSpecialty" class="form-control form-select">
                            <option value="">Select Specialty</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Pediatrics">Pediatrics</option>
                            <option value="Dermatology">Dermatology</option>
                            <option value="Orthopedics">Orthopedics</option>
                            <option value="Neurology">Neurology</option>
                            <option value="Psychiatry">Psychiatry</option>
                            <option value="Gynecology">Gynecology</option>
                            <option value="Urology">Urology</option>
                            <option value="Oncology">Oncology</option>
                            <option value="Radiology">Radiology</option>
                            <option value="Pathology">Pathology</option>
                            <option value="Emergency Medicine">Emergency Medicine</option>
                            <option value="Family Medicine">Family Medicine</option>
                            <option value="Internal Medicine">Internal Medicine</option>
                        </select>
                        <div class="form-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-lg" style="width: 100%;">
                            Create Account
                        </button>
                    </div>
                </form>
                
                <div class="text-center mt-3">
                    <p>Already have an account? <a href="#" onclick="showLoginModal()">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Help & Support</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h4>How to use Smart Clinic:</h4>
                <ul>
                    <li><strong>Patients:</strong> Register, book appointments, view prescriptions</li>
                    <li><strong>Doctors:</strong> Manage appointments, create prescriptions, view patient records</li>
                    <li><strong>Administrators:</strong> Manage system users and generate reports</li>
                </ul>
                
                <h4>Contact Information:</h4>
                <p>Email: support@smartclinic.com</p>
                <p>Phone: (555) 123-4567</p>
                <p>Hours: Mon-Fri 9AM-5PM</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Role selection logic
        let selectedRole = null;
        
        // Make functions globally available
        window.selectRole = selectRole;
        window.showLoginModal = showLoginModal;
        window.showSignupModal = showSignupModal;
        window.showHelpModal = showHelpModal;
        window.closeModal = closeModal;
        
        function selectRole(role) {
            selectedRole = role;
            setRole(role);
            showLoginModal();
        }
        
        function showLoginModal() {
            const modalTitle = document.getElementById('modalTitle');
            if (selectedRole) {
                modalTitle.textContent = `${capitalizeFirst(selectedRole)} Login`;
            }
            showModal('loginModal');
        }
        
        function showSignupModal() {
            const modalTitle = document.getElementById('signupModalTitle');
            const addressGroup = document.getElementById('addressGroup');
            const specialtyGroup = document.getElementById('specialtyGroup');
            
            if (selectedRole) {
                modalTitle.textContent = `${capitalizeFirst(selectedRole)} Registration`;
                
                // Show/hide fields based on role
                if (selectedRole === 'patient') {
                    addressGroup.style.display = 'block';
                    specialtyGroup.style.display = 'none';
                } else if (selectedRole === 'doctor') {
                    addressGroup.style.display = 'none';
                    specialtyGroup.style.display = 'block';
                } else {
                    addressGroup.style.display = 'none';
                    specialtyGroup.style.display = 'none';
                }
            }
            
            closeModal();
            showModal('signupModal');
        }
        
        function showHelpModal() {
            showModal('helpModal');
        }
        
        function closeModal() {
            closeAllModals();
        }
        
        // Form submission handlers
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);
        
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Clear previous errors
            clearFieldError('email');
            clearFieldError('password');
            
            // Validate inputs
            let hasErrors = false;
            
            if (!email) {
                showFieldError('email', 'Email is required');
                hasErrors = true;
            } else if (!validateEmail(email)) {
                showFieldError('email', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            if (!password) {
                showFieldError('password', 'Password is required');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            showLoading();
            
            try {
                let result;
                
                if (selectedRole === 'patient') {
                    const { patientLogin } = await import('./js/services/patientServices.js');
                    result = await patientLogin({ email, password });
                } else if (selectedRole === 'doctor') {
                    const { doctorLogin } = await import('./js/services/doctorServices.js');
                    result = await doctorLogin({ email, password });
                } else if (selectedRole === 'admin') {
                    const { adminLogin } = await import('./js/services/adminServices.js');
                    result = await adminLogin({ email, password });
                }
                
                hideLoading();
                
                if (result && result.success) {
                    showAlert('Login successful!', 'success');
                    closeModal();
                    
                    // Redirect based on role
                    setTimeout(() => {
                        switch (selectedRole) {
                            case 'patient':
                                redirectTo('/pages/patientDashboard.html');
                                break;
                            case 'doctor':
                                redirectTo('/templates/doctor/doctorDashboard.html');
                                break;
                            case 'admin':
                                redirectTo('/templates/admin/adminDashboard.html');
                                break;
                        }
                    }, 1000);
                } else {
                    showAlert(result?.message || 'Login failed. Please try again.', 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Login error:', error);
                showAlert('An error occurred during login. Please try again.', 'danger');
            }
        }
        
        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const phone = document.getElementById('signupPhone').value.trim();
            const address = document.getElementById('signupAddress').value.trim();
            const specialty = document.getElementById('signupSpecialty').value;
            
            // Clear previous errors
            ['signupName', 'signupEmail', 'signupPassword', 'signupPhone', 'signupAddress', 'signupSpecialty'].forEach(clearFieldError);
            
            // Validate inputs
            let hasErrors = false;
            
            if (!validateName(name)) {
                showFieldError('signupName', 'Name must be at least 3 characters');
                hasErrors = true;
            }
            
            if (!validateEmail(email)) {
                showFieldError('signupEmail', 'Please enter a valid email address');
                hasErrors = true;
            }
            
            if (!validatePassword(password)) {
                showFieldError('signupPassword', 'Password must be at least 6 characters');
                hasErrors = true;
            }
            
            if (!validatePhone(phone)) {
                showFieldError('signupPhone', 'Phone must be in format XXX-XXX-XXXX');
                hasErrors = true;
            }
            
            if (selectedRole === 'patient' && !address) {
                showFieldError('signupAddress', 'Address is required');
                hasErrors = true;
            }
            
            if (selectedRole === 'doctor' && !specialty) {
                showFieldError('signupSpecialty', 'Specialty is required');
                hasErrors = true;
            }
            
            if (hasErrors) return;
            
            showLoading();
            
            try {
                let result;
                const userData = { name, email, password, phone };
                
                if (selectedRole === 'patient') {
                    userData.address = address;
                    const { patientSignup } = await import('./js/services/patientServices.js');
                    result = await patientSignup(userData);
                } else if (selectedRole === 'doctor') {
                    userData.specialty = specialty;
                    const { doctorSignup } = await import('./js/services/doctorServices.js');
                    result = await doctorSignup(userData);
                }
                
                hideLoading();
                
                if (result && result.success) {
                    showAlert('Registration successful! Please login with your credentials.', 'success');
                    closeModal();
                    clearForm('signupForm');
                    setTimeout(() => showLoginModal(), 1000);
                } else {
                    showAlert(result?.message || 'Registration failed. Please try again.', 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Signup error:', error);
                showAlert('An error occurred during registration. Please try again.', 'danger');
            }
        }
        
        // Phone number formatting
        document.getElementById('signupPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6, 10);
            } else if (value.length >= 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            e.target.value = value;
        });
        
        // Keyboard navigation for role cards
        document.querySelectorAll('.role-card').forEach(card => {
            card.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any previous session data
            clearRole();
            clearAuthToken();
            clearUserData();
            
            console.log('Smart Clinic Home Page Initialized');
        });
    </script>
    
    <!-- Include the role-based login service -->
    <script type="module" src="js/services/index.js" defer></script>
</body>
</html>
